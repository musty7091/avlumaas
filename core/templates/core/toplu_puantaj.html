{% extends 'core/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>{{ personel.ad }} {{ personel.soyad }} - Toplu GiriÅŸ</h4>
    <a href="{% url 'personel_detay' personel.id %}" class="btn btn-outline-secondary btn-sm">Geri DÃ¶n</a>
</div>

<form method="GET" class="card p-3 mb-3 bg-light shadow-sm border-0">
    <div class="row g-2 align-items-center">
        <div class="col-auto"><label class="fw-bold">DÃ¶nem SeÃ§:</label></div>
        <div class="col-auto">
            <input type="number" name="ay" class="form-control" value="{{ ay }}" min="1" max="12" style="width: 70px;">
        </div>
        <div class="col-auto">
            <input type="number" name="yil" class="form-control" value="{{ yil }}" style="width: 100px;">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary btn-sm">Listele</button>
        </div>
    </div>
</form>

<form method="POST">
    {% csrf_token %}
    <div class="table-responsive shadow-sm bg-white rounded">
        <table class="table table-bordered table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th style="min-width: 180px;">Tarih</th> 
                    <th style="width: 160px;">Durum</th>
                    <th>GiriÅŸ</th>
                    <th>Ã‡Ä±kÄ±ÅŸ</th>
                    <th class="text-center" style="width: 140px;">Mesai / Durum</th>
                </tr>
            </thead>
            <tbody>
                {% for item in gunler_listesi %}
                <tr>
                    <td class="bg-light fw-bold text-nowrap">
                        {{ item.tarih|date:"d M Y" }} 
                        <span class="text-muted fw-normal ms-2">- {{ item.tarih|date:"l" }}</span>
                    </td>
                    
                    <td>
                        <select name="durum_{{ item.tarih_str }}" class="form-select form-select-sm" onchange="toggleRow(this)">
                            <option value="" {% if not item.kayit %}selected{% endif %}>-- SeÃ§iniz --</option>
                            <option value="geldi" {% if item.kayit.durum == 'geldi' %}selected{% endif %}>Geldi</option>
                            <option value="hafta_tatili" {% if item.kayit.durum == 'hafta_tatili' %}selected{% endif %}>Hafta Tatili</option>
                            <option value="gelmedi" {% if item.kayit.durum == 'gelmedi' %}selected{% endif %}>Gelmedi</option>
                            <option value="izinli" {% if item.kayit.durum == 'izinli' %}selected{% endif %}>Ä°zinli</option>
                            <option value="ucretsiz_izin" {% if item.kayit.durum == 'ucretsiz_izin' %}selected{% endif %}>Ãœcretsiz Ä°zin</option>
                            <option value="raporlu" {% if item.kayit.durum == 'raporlu' %}selected{% endif %}>Raporlu</option>
                        </select>
                    </td>

                    <td>
                        <input type="text" name="giris_{{ item.tarih_str }}" 
                               class="form-control form-control-sm saat-input text-center"
                               placeholder="" maxlength="5"
                               value="{% if item.kayit and item.kayit.giris_saati %}{{ item.kayit.giris_saati|date:'H:i' }}{% endif %}">
                    </td>
                    
                    <td>
                        <input type="text" name="cikis_{{ item.tarih_str }}" 
                               class="form-control form-control-sm saat-input text-center"
                               placeholder="" maxlength="5"
                               value="{% if item.kayit and item.kayit.cikis_saati %}{{ item.kayit.cikis_saati|date:'H:i' }}{% endif %}">
                    </td>

                    <td class="text-center">
                        {% if item.kayit %}
                            <span class="badge rounded-pill
                                {% if item.kayit.hesaplanan_mesai_saati > 0 %} bg-success 
                                {% elif item.kayit.hesaplanan_mesai_saati < 0 %} bg-danger 
                                {% else %} bg-secondary {% endif %}">
                                
                                {% if item.kayit.hesaplanan_mesai_saati > 0 %}
                                    +{{ item.kayit.hesaplanan_mesai_saati }} Saat
                                {% elif item.kayit.hesaplanan_mesai_saati < 0 %}
                                    {{ item.kayit.hesaplanan_mesai_saati }} Eksik
                                {% else %}
                                    Tamam
                                {% endif %}
                            </span>
                        {% else %}
                            <span class="badge bg-light text-muted border">Bekliyor</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="mt-4 mb-5 text-center">
        <button type="submit" class="btn btn-success btn-lg w-100 fw-bold shadow">
            ðŸ’¾ TÃœM AYI KAYDET
        </button>
    </div>
    
    <div style="height: 60px;"></div>
</form>

<script>
function toggleRow(select) {
    const tr = select.closest('tr');
    const inputs = tr.querySelectorAll('input.saat-input');
    
    const aktif = (select.value === 'geldi' || select.value === 'hafta_tatili');
    
    inputs.forEach(input => {
        input.disabled = !aktif;
        input.style.backgroundColor = !aktif ? '#e9ecef' : '#fff';
        input.style.color = !aktif ? '#6c757d' : '#000';
    });
}

function formatTimeInput(e) {
    let input = e.target;
    let value = input.value.replace(/\D/g, '');
    
    if (value.length > 4) value = value.slice(0, 4);

    if (value.length > 2) {
        input.value = value.slice(0, 2) + ':' + value.slice(2);
    } else {
        input.value = value;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('select').forEach(toggleRow);

    const saatInputs = document.querySelectorAll('.saat-input');
    saatInputs.forEach(input => {
        input.addEventListener('input', formatTimeInput);
    });
});
</script>
{% endblock %}